<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è°£è¨€ç”„åˆ«ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", sans-serif; background: #f5f5f5; }
        
        /* ç™»å½•/æ³¨å†ŒåŒºåŸŸæ ·å¼ */
        .container { width: 90%; max-width: 1000px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .title { text-align: center; margin-bottom: 30px; color: #333; }
        .section { margin-bottom: 20px; }
        /* å¼ºåŒ–éšè—æ ·å¼ï¼Œæå‡ä¼˜å…ˆçº§ */
        .hidden { display: none !important; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .hint { font-size: 12px; color: #999; margin-top: 5px; }
        .switch-btn { text-align: center; margin-top: 10px; color: #007bff; cursor: pointer; font-size: 14px; }
        .switch-btn:hover { text-decoration: underline; }

        /* ========== ChatGPTé£æ ¼å¯¹è¯åŒºåŸŸæ ·å¼ ========== */
        .chat-container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            height: 80vh;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            overflow: hidden;
            /* åˆå§‹é»˜è®¤éšè—ï¼Œé¿å…æœªç™»å½•æ—¶æ˜¾ç¤º */
            display: none;
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }
        .chat-header-btns {
            display: flex;
            gap: 10px;
        }
        .chat-header-btn {
            padding: 8px 16px;
            font-size: 14px;
            background: #6c757d;
        }
        .chat-header-btn:hover {
            background: #5a6268;
        }
        .cache-btn {
            background: #28a745 !important;
        }
        .cache-btn:hover {
            background: #218838 !important;
        }

        /* èŠå¤©å†…å®¹åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
        }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        /* æ¶ˆæ¯æ°”æ³¡é€šç”¨æ ·å¼ */
        .message {
            margin-bottom: 20px;
            display: flex;
            max-width: 85%;
        }
        /* ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ */
        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        /* ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ */
        .message.system {
            margin-right: auto;
        }

        /* æ¶ˆæ¯å¤´åƒ */
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .message.user .message-avatar {
            background: #28a745;
        }

        /* æ¶ˆæ¯å†…å®¹ */
        .message-content {
            margin: 0 12px;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            position: relative;
        }
        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.system .message-content {
            background: white;
            border: 1px solid #eee;
            border-bottom-left-radius: 4px;
            color: #333;
        }
        /* ç¼“å­˜æ ‡è®° */
        .cache-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* æ¶ˆæ¯å†…çš„ç»“æœè¯¦æƒ…æ ·å¼ */
        .result-detail {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
            font-size: 14px;
        }
        .result-detail p {
            margin-bottom: 5px;
            display: flex;
            align-items: flex-start;
        }
        .result-detail strong {
            min-width: 90px;
            display: inline-block;
            color: #555;
        }
        .reasoning-step {
            margin-left: 10px;
            margin-top: 3px;
            font-size: 13px;
            color: #666;
        }
        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .keyword-tag {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #495057;
        }
        
        /* è°£è¨€æ¦‚ç‡é¢œè‰²æ ·å¼ */
        .rumor-prob-high {
            color: #dc3545 !important;
            font-weight: bold;
        }
        .rumor-prob-medium {
            color: #ffc107 !important;
            font-weight: bold;
        }
        .rumor-prob-low {
            color: #28a745 !important;
            font-weight: bold;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .type-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .type-selector label {
            margin: 0;
            font-size: 14px;
        }
        .type-selector select {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        .text-input-container {
            position: relative;
        }
        #chat-message-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            height: 80px;
            font-size: 14px;
            line-height: 1.5;
        }
        .input-hint {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #999;
        }
        .send-btn-container {
            display: flex;
            justify-content: flex-end;
        }
        #send-message-btn {
            padding: 10px 24px;
            background: #007bff;
            font-size: 14px;
        }

        /* å†å²è®°å½•å¼¹çª—æ ·å¼ */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .history-modal-content {
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 12px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .history-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-modal-header h3 {
            font-size: 16px;
            color: #333;
        }
        .close-modal-btn {
            background: transparent;
            color: #666;
            font-size: 20px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .history-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
            border-radius: 6px;
            background: #f9fafb;
            transition: all 0.3s;
        }
        .history-item:hover {
            background: #e9ecef;
        }
        .history-item p {
            margin-bottom: 4px;
            font-size: 14px;
        }
        .history-item strong {
            color: #555;
            min-width: 90px;
            display: inline-block;
        }
        .history-cache-badge {
            background: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* ç»Ÿè®¡ä¿¡æ¯å¼¹çª— */
        .stats-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .stats-modal-content {
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 12px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .stats-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-modal-header h3 {
            font-size: 16px;
            color: #333;
        }
        .stats-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .stats-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .stats-item h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }
        .stats-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        .stats-list {
            margin-top: 10px;
        }
        .stats-list-item {
            padding: 8px;
            background: white;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æç¤ºä¿¡æ¯ */
        .info-banner {
            padding: 10px 15px;
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* æœç´¢æ‘˜è¦æ ·å¼ */
        .search-summary {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid #17a2b8;
        }
        
        /* éªŒè¯å»ºè®®æ ·å¼ */
        .verification-suggestions {
            margin-top: 8px;
            padding: 6px 10px;
            background: #fff3cd;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid #ffc107;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸ -->
    <div class="container" id="auth-container">
        <h1 class="title">è°£è¨€ç”„åˆ«ç³»ç»Ÿ</h1>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div id="login-section" class="section">
            <h2>ç”¨æˆ·ç™»å½•</h2>
            <div>
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div style="margin-top: 15px;">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button id="login-btn" style="width:100%; margin-top:10px;">ç™»å½•</button>
            <div class="switch-btn" id="to-register-btn">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</div>
        </div>

        <!-- æ³¨å†ŒåŒºåŸŸ -->
        <div id="register-section" class="section hidden">
            <h2>ç”¨æˆ·æ³¨å†Œ</h2>
            <div>
                <label for="reg-username">ç”¨æˆ·å</label>
                <input type="text" id="reg-username" placeholder="è¯·è®¾ç½®ç”¨æˆ·å">
            </div>
            <div style="margin-top: 15px;">
                <label for="reg-password">å¯†ç </label>
                <input type="password" id="reg-password" placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆ6-72ä½ï¼‰">
            </div>
            <div style="margin-top: 15px;">
                <label for="reg-confirm-password">ç¡®è®¤å¯†ç </label>
                <input type="password" id="reg-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
            </div>
            <button id="register-btn" style="width:100%; margin-top:10px;">æ³¨å†Œ</button>
            <div class="switch-btn" id="to-login-btn">å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•</div>
        </div>
    </div>

    <!-- ========== ChatGPTé£æ ¼å¯¹è¯åŒºåŸŸ ========== -->
    <div class="chat-container" id="chat-container">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="chat-header">
            <h2>è°£è¨€ç”„åˆ«åŠ©æ‰‹</h2>
            <div class="chat-header-btns">
                <button class="chat-header-btn cache-btn" id="stats-btn">ğŸ“Š ç¼“å­˜ç»Ÿè®¡</button>
                <button class="chat-header-btn" id="history-btn">ğŸ“œ å†å²è®°å½•</button>
                <button class="chat-header-btn" id="logout-btn">ğŸšª é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
        <div class="chat-messages" id="chat-messages">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message system">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="info-banner">
                        <strong>ğŸ“¢ ç³»ç»Ÿæç¤ºï¼š</strong> ç³»ç»Ÿå·²å¯ç”¨ç¼“å­˜åŠŸèƒ½ï¼Œç›¸åŒå†…å®¹å°†ä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼ŒèŠ‚çœAPIè°ƒç”¨å¹¶æé«˜å“åº”é€Ÿåº¦ã€‚
                    </div>
                    ä½ å¥½ï¼æˆ‘æ˜¯è°£è¨€ç”„åˆ«åŠ©æ‰‹ï¼Œè¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬ï¼Œæˆ‘ä¼šä¸ºä½ åˆ†ææ˜¯å¦ä¸ºè°£è¨€ä»¥åŠç›¸å…³æ¨ç†è¿‡ç¨‹ã€‚
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-area">
            <div class="input-container">
                <div class="type-selector">
                    <label for="rumor-type">è°£è¨€ç±»å‹ï¼š</label>
                    <select id="rumor-type">
                        <option value="ç–«æƒ…ç›¸å…³">ç–«æƒ…ç›¸å…³</option>
                        <option value="é£Ÿå“å®‰å…¨">é£Ÿå“å®‰å…¨</option>
                        <option value="ç¤¾ä¼šäº‹ä»¶">ç¤¾ä¼šäº‹ä»¶</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="text-input-container">
                    <textarea id="chat-message-input" placeholder="è¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬ï¼ˆ1-500å­—ï¼‰..."></textarea>
                    <div class="input-hint" id="input-length-hint">0/500</div>
                </div>
                <div class="send-btn-container">
                    <button id="send-message-btn">
                        <span id="send-btn-text">å‘é€æ£€æµ‹</span>
                        <span id="loading-indicator" class="loading hidden"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div class="history-modal" id="history-modal">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h3>æ£€æµ‹å†å²è®°å½•</h3>
                <button class="close-modal-btn" id="close-history-btn">Ã—</button>
            </div>
            <div class="history-modal-body" id="history-list">
                <!-- å†å²è®°å½•å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- ç¼“å­˜ç»Ÿè®¡å¼¹çª— -->
    <div class="stats-modal" id="stats-modal">
        <div class="stats-modal-content">
            <div class="stats-modal-header">
                <h3>ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯</h3>
                <button class="close-modal-btn" id="close-stats-btn">Ã—</button>
            </div>
            <div class="stats-modal-body" id="stats-content">
                <!-- ç»Ÿè®¡å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Axios -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let token = "";
        let userId = "";
        let isSending = false;

        // DOMå…ƒç´ è·å–
        // ç™»å½•/æ³¨å†Œç›¸å…³
        const authContainer = document.getElementById("auth-container");
        const loginSection = document.getElementById("login-section");
        const registerSection = document.getElementById("register-section");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById("login-btn");
        const toRegisterBtn = document.getElementById("to-register-btn");
        const regUsernameInput = document.getElementById("reg-username");
        const regPasswordInput = document.getElementById("reg-password");
        const regConfirmPasswordInput = document.getElementById("reg-confirm-password");
        const registerBtn = document.getElementById("register-btn");
        const toLoginBtn = document.getElementById("to-login-btn");

        // èŠå¤©åŒºåŸŸç›¸å…³
        const chatContainer = document.getElementById("chat-container");
        const chatMessages = document.getElementById("chat-messages");
        const chatMessageInput = document.getElementById("chat-message-input");
        const inputLengthHint = document.getElementById("input-length-hint");
        const rumorTypeSelect = document.getElementById("rumor-type");
        const sendMessageBtn = document.getElementById("send-message-btn");
        const sendBtnText = document.getElementById("send-btn-text");
        const loadingIndicator = document.getElementById("loading-indicator");
        const historyBtn = document.getElementById("history-btn");
        const statsBtn = document.getElementById("stats-btn");
        const logoutBtn = document.getElementById("logout-btn");

        // å¼¹çª—ç›¸å…³
        const historyModal = document.getElementById("history-modal");
        const historyList = document.getElementById("history-list");
        const closeHistoryBtn = document.getElementById("close-history-btn");
        const statsModal = document.getElementById("stats-modal");
        const statsContent = document.getElementById("stats-content");
        const closeStatsBtn = document.getElementById("close-stats-btn");

        // é¡µé¢åŠ è½½å®Œæˆåå¼ºåˆ¶åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
        window.onload = function() {
            // å¼ºåˆ¶éšè—èŠå¤©å®¹å™¨
            chatContainer.style.display = "none";
            // ç¡®ä¿ç™»å½•/æ³¨å†Œå®¹å™¨æ˜¾ç¤º
            authContainer.style.display = "block";
            // ä½¿ç”¨classListç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºçŠ¶æ€
            loginSection.classList.remove("hidden");
            registerSection.classList.add("hidden");
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œæç¤º
            chatMessageInput.value = "";
            inputLengthHint.textContent = "0/500";
            // éšè—å¼¹çª—
            historyModal.style.display = "none";
            statsModal.style.display = "none";
            // æ¸…ç©ºç™»å½•/æ³¨å†Œè¾“å…¥æ¡†
            usernameInput.value = "";
            passwordInput.value = "";
            regUsernameInput.value = "";
            regPasswordInput.value = "";
            regConfirmPasswordInput.value = "";
            
            console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆ");
        };

        // ç™»å½•/æ³¨å†Œåˆ‡æ¢é€»è¾‘
        function switchTab(tabName) {
            console.log("åˆ‡æ¢åˆ°:", tabName);
            if (tabName === "login") {
                loginSection.classList.remove("hidden");
                registerSection.classList.add("hidden");
            } else {
                loginSection.classList.add("hidden");
                registerSection.classList.remove("hidden");
            }
        }

        toRegisterBtn.addEventListener("click", () => {
            console.log("ç‚¹å‡»åˆ‡æ¢åˆ°æ³¨å†Œ");
            switchTab("register");
        });
        
        toLoginBtn.addEventListener("click", () => {
            console.log("ç‚¹å‡»åˆ‡æ¢åˆ°ç™»å½•");
            switchTab("login");
        });

        // å·¥å…·å‡½æ•°ï¼šæç¤ºæ¡†
        function showToast(msg, isError = false) {
            alert(msg);
        }

        // è®¾ç½®å‘é€çŠ¶æ€
        function setSendingState(isSending) {
            if (isSending) {
                sendBtnText.textContent = "æ£€æµ‹ä¸­...";
                loadingIndicator.classList.remove("hidden");
                sendMessageBtn.disabled = true;
                chatMessageInput.disabled = true;
                rumorTypeSelect.disabled = true;
            } else {
                sendBtnText.textContent = "å‘é€æ£€æµ‹";
                loadingIndicator.classList.add("hidden");
                sendMessageBtn.disabled = false;
                chatMessageInput.disabled = false;
                rumorTypeSelect.disabled = false;
            }
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–è°£è¨€æ¦‚ç‡é¢œè‰²ç±»
        function getRumorProbClass(prob) {
            if (prob >= 0.7) return "rumor-prob-high";
            if (prob >= 0.3) return "rumor-prob-medium";
            return "rumor-prob-low";
        }

        // å·¥å…·å‡½æ•°ï¼šæ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ - ä¿®å¤ç‰ˆ
        function addMessageToChat(content, isUser = false, resultData = null) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${isUser ? "user" : "system"}`;
            
            // å¤´åƒ
            const avatarDiv = document.createElement("div");
            avatarDiv.className = "message-avatar";
            avatarDiv.textContent = isUser ? "ğŸ‘¤" : "ğŸ¤–";
            
            // å†…å®¹
            const contentDiv = document.createElement("div");
            contentDiv.className = "message-content";
            
            // å¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ä¸”æœ‰æ£€æµ‹ç»“æœ
            if (!isUser && resultData) {
                // è®¾ç½®æ¶ˆæ¯æ ‡é¢˜
                let title = "å¤§æ¨¡å‹åˆ†æå®Œæˆï¼š";
                if (resultData.from_cache) {
                    title = "âœ… å·²ä»ç¼“å­˜è·å–æ£€æµ‹ç»“æœï¼š";
                } else if (resultData.search_used) {
                    title = "ğŸ¤– å¤§æ¨¡å‹åˆ†æå®Œæˆï¼ˆå«ç½‘ç»œéªŒè¯ï¼‰ï¼š";
                } else {
                    title = "ğŸ¤– å¤§æ¨¡å‹åˆ†æå®Œæˆï¼š";
                }
                
                // åˆ›å»ºæ ‡é¢˜æ–‡æœ¬èŠ‚ç‚¹
                const titleNode = document.createTextNode(title);
                contentDiv.appendChild(titleNode);
                
                // æ·»åŠ ç¼“å­˜æ ‡è®°
                if (resultData.from_cache) {
                    const cacheBadge = document.createElement("div");
                    cacheBadge.className = "cache-badge";
                    cacheBadge.textContent = "ç¼“å­˜";
                    contentDiv.appendChild(cacheBadge);
                }
                
                // åˆ›å»ºç»“æœè¯¦æƒ…å®¹å™¨
                const resultDetailDiv = document.createElement("div");
                resultDetailDiv.className = "result-detail";
                
                // æå–æ•°æ®
                let aiGeneratedText = resultData.is_ai_generated ? "æ˜¯" : "å¦";
                
                // æ¨ç†æ­¥éª¤
                let reasoningStepsHtml = "";
                if (resultData.reasoning_steps && Array.isArray(resultData.reasoning_steps)) {
                    resultData.reasoning_steps.forEach((step, index) => {
                        reasoningStepsHtml += `<div class="reasoning-step">${index + 1}. ${step}</div>`;
                    });
                }
                
                // å…³é”®å­—å±•ç¤º
                let keywordsHtml = "";
                if (resultData.keywords && Array.isArray(resultData.keywords)) {
                    keywordsHtml = '<div class="keywords-list">';
                    resultData.keywords.forEach(keyword => {
                        keywordsHtml += `<span class="keyword-tag">${keyword}</span>`;
                    });
                    keywordsHtml += '</div>';
                }
                
                // ç¼“å­˜ä¿¡æ¯
                let cacheInfo = "";
                if (resultData.from_cache !== undefined) {
                    cacheInfo = `<p><strong>ğŸ“Š æ¥æºï¼š</strong>${resultData.from_cache ? 'æ•°æ®åº“ç¼“å­˜' : 'å¤§æ¨¡å‹å®æ—¶åˆ†æ'}</p>`;
                    cacheInfo += `<p><strong>ğŸ”„ ä½¿ç”¨æ¬¡æ•°ï¼š</strong>${resultData.use_count || 1} æ¬¡</p>`;
                }
                
                // æœç´¢ä¿¡æ¯
                let searchInfo = "";
                if (resultData.search_used) {
                    searchInfo = `<p><strong>ğŸ” ç½‘ç»œéªŒè¯ï¼š</strong>å·²ä½¿ç”¨DuckDuckGoæœç´¢</p>`;
                    if (resultData.search_result_count) {
                        searchInfo += `<p><strong>ğŸ“Š æœç´¢ç»“æœï¼š</strong>${resultData.search_result_count}æ¡</p>`;
                    }
                }
                
                // ç½®ä¿¡åº¦å’ŒéªŒè¯å»ºè®®
                let confidenceInfo = "";
                if (resultData.confidence) {
                    confidenceInfo = `<p><strong>ğŸ“Š ç½®ä¿¡åº¦ï¼š</strong>${resultData.confidence}</p>`;
                }
                
                let verificationInfo = "";
                if (resultData.verification_suggestions && Array.isArray(resultData.verification_suggestions)) {
                    verificationInfo = `<div class="verification-suggestions">`;
                    verificationInfo += `<strong>ğŸ’¡ éªŒè¯å»ºè®®ï¼š</strong><br>`;
                    resultData.verification_suggestions.forEach((suggestion, index) => {
                        verificationInfo += `${index + 1}. ${suggestion}<br>`;
                    });
                    verificationInfo += `</div>`;
                }
                
                // è°£è¨€æ¦‚ç‡é¢œè‰²ç±»
                const rumorProbClass = getRumorProbClass(resultData.rumor_prob || 0.5);
                
                // æ„å»ºç»“æœè¯¦æƒ…HTML
                resultDetailDiv.innerHTML = `
                    ${cacheInfo}
                    ${searchInfo}
                    ${confidenceInfo}
                    <p><strong>ğŸ”‘ æ ¸å¿ƒå…³é”®å­—ï¼š</strong></p>
                    ${keywordsHtml}
                    <p><strong>ğŸ“ˆ è°£è¨€æ¦‚ç‡ï¼š</strong><span class="${rumorProbClass}">${resultData.rumor_prob || 0.5000}</span></p>
                    <p><strong>ğŸ¤– æ˜¯å¦AIç”Ÿæˆï¼š</strong>${aiGeneratedText}</p>
                    <!-- æ–°å¢ï¼šæ˜ç¡®æ˜¾ç¤ºæ˜¯å¦ä¸ºè°£è¨€ -->
                    <div style="margin: 15px 0; padding: 12px; background: ${resultData.is_rumor ? '#f8d7da' : '#d1ecf1'}; border-radius: 6px; border-left: 4px solid ${resultData.is_rumor ? '#dc3545' : '#17a2b8'};">
                    <strong style="font-size: 16px; color: ${resultData.is_rumor ? '#721c24' : '#0c5460'};">ğŸ“¢ æœ€ç»ˆåˆ¤æ–­ï¼š</strong>
                    <p style="margin: 8px 0 0 0; font-size: 16px; font-weight: bold; color: ${resultData.is_rumor ? '#dc3545' : '#28a745'};">${resultData.conclusion || (resultData.is_rumor ? 'ç»åˆ†æï¼Œè¯¥ä¿¡æ¯ã€æ˜¯è°£è¨€ã€‘ã€‚' : 'ç»åˆ†æï¼Œè¯¥ä¿¡æ¯ã€ä¸æ˜¯è°£è¨€ã€‘ã€‚')}</p>
                    </div>
                    ${verificationInfo}
                    <p><strong>ğŸ§  æ¨ç†è¿‡ç¨‹ï¼š</strong></p>
                    ${reasoningStepsHtml}
                `;
                
                // å¦‚æœæœ‰æœç´¢æ‘˜è¦ï¼Œæ·»åŠ è¿›å»
                if (resultData.search_summary) {
                    const searchDiv = document.createElement("div");
                    searchDiv.className = "search-summary";
                    searchDiv.innerHTML = `<strong>ğŸŒ æœç´¢æ‘˜è¦ï¼š</strong><br>${resultData.search_summary}`;
                    resultDetailDiv.appendChild(searchDiv);
                }
                
                // å¦‚æœæœ‰é¢å¤–çš„æœç´¢ç›¸å…³å­—æ®µï¼Œä¹Ÿæ˜¾ç¤º
                if (resultData.search_result_summary) {
                    const searchResultDiv = document.createElement("div");
                    searchResultDiv.className = "search-summary";
                    searchResultDiv.innerHTML = `<strong>ğŸ” æœç´¢ç»“æœæ€»ç»“ï¼š</strong><br>${resultData.search_result_summary}`;
                    resultDetailDiv.appendChild(searchResultDiv);
                }
                
                if (resultData.key_findings_from_search && Array.isArray(resultData.key_findings_from_search)) {
                    const findingsDiv = document.createElement("div");
                    findingsDiv.className = "verification-suggestions";
                    findingsDiv.innerHTML = `<strong>ğŸ” æœç´¢å…³é”®å‘ç°ï¼š</strong><br>` + 
                        resultData.key_findings_from_search.map((finding, index) => 
                            `${index + 1}. ${finding}`
                        ).join('<br>');
                    resultDetailDiv.appendChild(findingsDiv);
                }
                
                contentDiv.appendChild(resultDetailDiv);
            } else {
                // å¦‚æœæ˜¯æ™®é€šç³»ç»Ÿæ¶ˆæ¯
                contentDiv.textContent = content;
            }
            
            // ç»„è£…æ¶ˆæ¯å…ƒç´ 
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ³¨å†Œé€»è¾‘
        registerBtn.addEventListener("click", async () => {
            const username = regUsernameInput.value.trim();
            const password = regPasswordInput.value.trim();
            const confirmPassword = regConfirmPasswordInput.value.trim();

            console.log("æ³¨å†Œå°è¯•ï¼Œç”¨æˆ·å:", username, "å¯†ç é•¿åº¦:", password.length);

            if (!username || !password || !confirmPassword) {
                showToast("æ‰€æœ‰å­—æ®µä¸èƒ½ä¸ºç©ºï¼", true);
                return;
            }
            if (password.length < 6 || password.length > 72) {
                showToast("å¯†ç é•¿åº¦éœ€6-72ä½ï¼", true);
                return;
            }
            if (password !== confirmPassword) {
                showToast("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼", true);
                return;
            }

            try {
                const response = await axios.post(
                    "http://localhost:8000/api/register",
                    { 
                        username: username, 
                        password: password, 
                        confirm_password: confirmPassword 
                    }
                );

                console.log("æ³¨å†Œå“åº”:", response.data);

                if (response.data.code === 200) {
                    showToast("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ï¼");
                    
                    // åˆ‡æ¢åˆ°ç™»å½•ç•Œé¢
                    switchTab("login");
                    
                    // è‡ªåŠ¨å¡«å……ç”¨æˆ·ååˆ°ç™»å½•æ¡†
                    usernameInput.value = username;
                    
                    // æ¸…ç©ºæ³¨å†Œè¾“å…¥æ¡†
                    regUsernameInput.value = "";
                    regPasswordInput.value = "";
                    regConfirmPasswordInput.value = "";
                } else {
                    showToast(response.data.msg || "æ³¨å†Œå¤±è´¥ï¼", true);
                }
            } catch (error) {
                console.error("æ³¨å†Œé”™è¯¯:", error);
                const errMsg = error.response?.data?.detail || error.message || "æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                showToast(errMsg, true);
            }
        });

        // ç™»å½•é€»è¾‘
        loginBtn.addEventListener("click", async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showToast("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼", true);
                return;
            }

            try {
                const response = await axios.post(
                    "http://localhost:8000/api/login",
                    { username: username, password: password }
                );

                if (response.data.code === 200) {
                    token = response.data.data.token;
                    userId = response.data.data.user_id;
                    showToast("ç™»å½•æˆåŠŸï¼");
                    
                    // éšè—ç™»å½•/æ³¨å†ŒåŒºåŸŸï¼Œæ˜¾ç¤ºèŠå¤©åŒºåŸŸ
                    authContainer.style.display = "none";
                    chatContainer.style.display = "flex";
                }
            } catch (error) {
                const errMsg = error.response?.data?.detail || "ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                showToast(errMsg, true);
            }
        });

        // é€€å‡ºç™»å½•é€»è¾‘
        logoutBtn.addEventListener("click", () => {
            // æ¸…ç©ºtokenå’Œç”¨æˆ·ä¿¡æ¯
            token = "";
            userId = "";
            // æ¸…ç©ºèŠå¤©è®°å½•
            chatMessages.innerHTML = `
                <div class="message system">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="info-banner">
                            <strong>ğŸ“¢ ç³»ç»Ÿæç¤ºï¼š</strong> ç³»ç»Ÿå·²å¯ç”¨ç¼“å­˜åŠŸèƒ½ï¼Œç›¸åŒå†…å®¹å°†ä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼ŒèŠ‚çœAPIè°ƒç”¨å¹¶æé«˜å“åº”é€Ÿåº¦ã€‚
                        </div>
                        ä½ å¥½ï¼æˆ‘æ˜¯è°£è¨€ç”„åˆ«åŠ©æ‰‹ï¼Œè¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬ï¼Œæˆ‘ä¼šä¸ºä½ åˆ†ææ˜¯å¦ä¸ºè°£è¨€ä»¥åŠç›¸å…³æ¨ç†è¿‡ç¨‹ã€‚
                    </div>
                </div>
            `;
            // éšè—èŠå¤©åŒºåŸŸï¼Œæ˜¾ç¤ºç™»å½•åŒºåŸŸ
            chatContainer.style.display = "none";
            authContainer.style.display = "block";
            
            // é‡ç½®ç™»å½•/æ³¨å†Œç•Œé¢çŠ¶æ€
            loginSection.classList.remove("hidden");
            registerSection.classList.add("hidden");
            
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
            chatMessageInput.value = "";
            inputLengthHint.textContent = "0/500";
            usernameInput.value = "";
            passwordInput.value = "";
            regUsernameInput.value = "";
            regPasswordInput.value = "";
            regConfirmPasswordInput.value = "";
            
            // æ˜¾ç¤ºæç¤º
            showToast("å·²é€€å‡ºç™»å½•");
        });

        // è¾“å…¥æ¡†é•¿åº¦å®æ—¶æ£€æµ‹
        chatMessageInput.addEventListener("input", () => {
            const length = chatMessageInput.value.length;
            inputLengthHint.textContent = `${length}/500`;
            inputLengthHint.style.color = length > 500 ? "red" : "#999";
        });

        // å‘é€æ£€æµ‹æ¶ˆæ¯é€»è¾‘
        sendMessageBtn.addEventListener("click", async () => {
            if (isSending) return;
            
            const content = chatMessageInput.value.trim();
            const type = rumorTypeSelect.value;

            // æ ¡éªŒæ–‡æœ¬é•¿åº¦
            if (content.length < 1 || content.length > 500) {
                showToast("æ–‡æœ¬é•¿åº¦å¿…é¡»åœ¨1-500å­—ä¹‹é—´ï¼", true);
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            addMessageToChat(content, true);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatMessageInput.value = "";
            inputLengthHint.textContent = "0/500";
            
            // è®¾ç½®å‘é€çŠ¶æ€
            isSending = true;
            setSendingState(true);

            // è°ƒç”¨æ£€æµ‹æ¥å£
            try {
                const response = await axios.post(
                    "http://localhost:8000/api/detect",
                    { content: content, type: type },
                    { headers: { "Authorization": `Bearer ${token}` } }
                );

                console.log("æ£€æµ‹å“åº”:", response.data);

                if (response.data.code === 200) {
                    const data = response.data.data;
                    console.log("æ£€æµ‹æ•°æ®è¯¦æƒ…:", {
                        hasReasoningSteps: !!data.reasoning_steps,
                        reasoningStepsLength: data.reasoning_steps?.length,
                        hasKeywords: !!data.keywords,
                        keywordsLength: data.keywords?.length,
                        rumorProb: data.rumor_prob,
                        fromCache: data.from_cache,
                        searchUsed: data.search_used
                    });
                    
                    // æ·»åŠ ç³»ç»Ÿå›å¤æ¶ˆæ¯
                    addMessageToChat("", false, data);
                    
                    // æ˜¾ç¤ºæ¥æºæç¤º
                    if (data.from_cache) {
                        showToast(`âœ… æ£€æµ‹å®Œæˆï¼ˆæ¥è‡ªç¼“å­˜ï¼Œå·²ä½¿ç”¨ ${data.use_count} æ¬¡ï¼‰`);
                    } else if (data.search_used) {
                        showToast("âœ… æ£€æµ‹å®Œæˆï¼ˆå«ç½‘ç»œéªŒè¯ï¼‰");
                    } else {
                        showToast("âœ… æ£€æµ‹å®Œæˆï¼ˆå®æ—¶åˆ†æï¼‰");
                    }
                } else {
                    addMessageToChat(`æ£€æµ‹å¤±è´¥ï¼š${response.data.msg || "æœªçŸ¥é”™è¯¯"}`, false);
                    showToast(response.data.msg || "æ£€æµ‹å¤±è´¥ï¼", true);
                }
            } catch (error) {
                console.error("æ£€æµ‹è¯·æ±‚é”™è¯¯:", error);
                const errMsg = error.response?.data?.detail || error.response?.data?.msg || error.message || "æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                addMessageToChat(`æ£€æµ‹å‡ºé”™ï¼š${errMsg}`, false);
                showToast(errMsg, true);
            } finally {
                // æ¢å¤å‘é€çŠ¶æ€
                isSending = false;
                setSendingState(false);
            }
        });

// æŸ¥çœ‹å†å²è®°å½•é€»è¾‘
historyBtn.addEventListener("click", async () => {
    try {
        const response = await axios.get("http://localhost:8000/api/history", {
            headers: { "Authorization": `Bearer ${token}` },
            params: { page: 1, size: 20 }
        });

        if (response.data.code === 200) {
            const historyData = response.data.data.list;
            historyList.innerHTML = "";

            if (historyData.length === 0) {
                historyList.innerHTML = "<p style='text-align:center; color:#999;'>æš‚æ— æ£€æµ‹è®°å½•</p>";
            } else {
                historyData.forEach(item => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "history-item";
                    
                    let cacheInfo = "";
                    if (item.use_count && item.use_count > 1) {
                        cacheInfo = `<span class="history-cache-badge">å·²ä½¿ç”¨ ${item.use_count} æ¬¡</span>`;
                    }
                    
                    // å…³é”®å­—å±•ç¤º
                    let keywordsHtml = "";
                    if (item.keywords && Array.isArray(item.keywords)) {
                        item.keywords.forEach(keyword => {
                            keywordsHtml += `<span style="background:#e9ecef; padding:2px 6px; border-radius:12px; font-size:12px; margin-right:4px;">${keyword}</span>`;
                        });
                    }
                    
                    // è°£è¨€æ¦‚ç‡é¢œè‰²
                    const rumorProbClass = getRumorProbClass(item.rumor_prob || 0.5);
                    
                    // ç»“è®ºæ˜¾ç¤ºæ ·å¼
                    const conclusion = item.conclusion || (item.rumor_prob >= 0.5 ? "ç»åˆ†æï¼Œè¯¥ä¿¡æ¯ã€æ˜¯è°£è¨€ã€‘ã€‚" : "ç»åˆ†æï¼Œè¯¥ä¿¡æ¯ã€ä¸æ˜¯è°£è¨€ã€‘ã€‚");
                    const isRumor = conclusion.includes("ã€æ˜¯è°£è¨€ã€‘");
                    const conclusionStyle = `style="margin: 8px 0; padding: 8px; background: ${isRumor ? '#f8d7da' : '#d1ecf1'}; border-radius: 4px; border-left: 4px solid ${isRumor ? '#dc3545' : '#28a745'};"`;
                    
                    itemDiv.innerHTML = `
                        <p><strong>æ£€æµ‹æ—¶é—´ï¼š</strong>${item.last_used_time || item.create_time} ${cacheInfo}</p>
                        <p><strong>æ–‡æœ¬ï¼š</strong>${item.content.length > 60 ? item.content.substring(0, 60) + "..." : item.content}</p>
                        <div ${conclusionStyle}>
                            <strong>ğŸ“¢ ç»“è®ºï¼š</strong>${conclusion}
                        </div>
                        <p><strong>å…³é”®å­—ï¼š</strong>${keywordsHtml}</p>
                        <p><strong>ç±»å‹ï¼š</strong>${item.type}</p>
                        <p><strong>è°£è¨€æ¦‚ç‡ï¼š</strong><span class="${rumorProbClass}">${item.rumor_prob}</span></p>
                        <p><strong>æ˜¯å¦AIç”Ÿæˆï¼š</strong>${item.is_ai_generated ? "æ˜¯" : "å¦"}</p>
                    `;
                    historyList.appendChild(itemDiv);
                });
            }

            // æ˜¾ç¤ºå¼¹çª—
            historyModal.style.display = "flex";
        }
    } catch (error) {
        const errMsg = error.response?.data?.detail || "æŸ¥è¯¢å†å²å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
        showToast(errMsg, true);
    }
});

// æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡é€»è¾‘
statsBtn.addEventListener("click", async () => {
    try {
        const response = await axios.get("http://localhost:8000/api/duplicate-stats", {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (response.data.code === 200) {
            const statsData = response.data.data;
            statsContent.innerHTML = "";
            
            if (!statsData) {
                statsContent.innerHTML = "<p style='text-align:center; color:#999;'>æš‚æ— ç»Ÿè®¡æ•°æ®</p>";
            } else {
                statsContent.innerHTML = `
                    <div class="stats-item">
                        <h4>ğŸ“Š æ€»ä½“ç»Ÿè®¡</h4>
                        <div class="stats-value">${statsData.total_records || 0}</div>
                        <p>æ€»æ£€æµ‹è®°å½•</p>
                    </div>
                    
                    <div class="stats-item">
                        <h4>ğŸ’¾ ç¼“å­˜æ•ˆç‡</h4>
                        <div class="stats-value">${statsData.cache_hit_rate || "0%"}</div>
                        <p>ç¼“å­˜å‘½ä¸­ç‡</p>
                        <p>é‡å¤è®°å½•ï¼š${statsData.duplicate_records || 0} æ¡</p>
                    </div>
                    
                    <div class="stats-item">
                        <h4>ğŸ”¥ çƒ­é—¨æ£€æµ‹å†…å®¹</h4>
                        <div class="stats-list">
                            ${statsData.most_used_contents && statsData.most_used_contents.length > 0 
                                ? statsData.most_used_contents.map(item => 
                                    `<div class="stats-list-item">
                                        <p>${item.content}</p>
                                        <p style="font-size:14px; color:#333; margin-top:5px; padding: 5px; background: ${item.conclusion.includes('ã€æ˜¯è°£è¨€ã€‘') ? '#f8d7da' : '#d1ecf1'}; border-radius: 4px;">
                                            <strong>ç»“è®ºï¼š</strong>${item.conclusion}
                                        </p>
                                        <p style="font-size:12px; color:#666; margin-top:5px;">ä½¿ç”¨æ¬¡æ•°: ${item.use_count} | æœ€åä½¿ç”¨: ${item.last_used}</p>
                                    </div>`
                                ).join('')
                                : '<p style="text-align:center; color:#999;">æš‚æ— çƒ­é—¨å†…å®¹</p>'
                            }
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; padding:10px; background:#e7f3ff; border-radius:6px; font-size:14px;">
                        <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>
                        <p>1. ç³»ç»Ÿä¼šè‡ªåŠ¨ç¼“å­˜æ£€æµ‹ç»“æœï¼Œç›¸åŒå†…å®¹ä¸å†é‡å¤è°ƒç”¨å¤§æ¨¡å‹</p>
                        <p>2. ç¼“å­˜å‘½ä¸­ç‡è¶Šé«˜ï¼Œè¯´æ˜ç³»ç»Ÿå¤ç”¨æ•ˆç‡è¶Šé«˜</p>
                        <p>3. æ¯æ¬¡ä½¿ç”¨ç¼“å­˜å†…å®¹ï¼Œä½¿ç”¨æ¬¡æ•°ä¼šè‡ªåŠ¨å¢åŠ </p>
                        <p>4. ç»“è®ºä¼šæ˜ç¡®æ˜¾ç¤ºã€æ˜¯è°£è¨€ã€‘æˆ–ã€ä¸æ˜¯è°£è¨€ã€‘</p>
                    </div>
                `;
            }

            // æ˜¾ç¤ºå¼¹çª—
            statsModal.style.display = "flex";
        }
    } catch (error) {
        console.error("è·å–ç»Ÿè®¡ä¿¡æ¯é”™è¯¯:", error);
        const errMsg = error.response?.data?.detail || "è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
        showToast(errMsg, true);
    }
});
        // å…³é—­å†å²è®°å½•å¼¹çª—
        closeHistoryBtn.addEventListener("click", () => {
            historyModal.style.display = "none";
        });

        // å…³é—­ç»Ÿè®¡å¼¹çª—
        closeStatsBtn.addEventListener("click", () => {
            statsModal.style.display = "none";
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.addEventListener("click", (e) => {
            if (e.target === historyModal) {
                historyModal.style.display = "none";
            }
            if (e.target === statsModal) {
                statsModal.style.display = "none";
            }
        });

        // æŒ‰Enteré”®å‘é€æ¶ˆæ¯ï¼ˆæŒ‰ä½Shift+Enteræ¢è¡Œï¼‰
        chatMessageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                if (!isSending) {
                    sendMessageBtn.click();
                }
            }
        });

        // ç¤ºä¾‹æ–‡æœ¬å¿«é€Ÿå¡«å……
        function fillExampleText() {
            const examples = [
                "åƒèŠ¹èœèƒ½é™è¡€å‹ï¼Œæ¯å¤©åƒä¸€æ–¤æ•ˆæœæœ€å¥½",
                "æ‰‹æœºå……ç”µæ—¶è¾å°„ä¼šå¢å¤§100å€ï¼Œå¯¹å¥åº·æœ‰å®³",
                "å–å¯ä¹ä¼šå¯¼è‡´éª¨è´¨ç–æ¾ï¼Œå®¹æ˜“éª¨æŠ˜",
                "æ™šä¸Šåƒè‹¹æœç­‰äºåƒç ’éœœï¼Œå¯¹èº«ä½“æœ‰å®³",
                "æ–°å† ç—…æ¯’å¯ä»¥é€šè¿‡5Gç½‘ç»œä¼ æ’­",
                "æ‰“æ–°å† ç–«è‹—ä¼šæ”¹å˜äººä½“åŸºå› "
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            chatMessageInput.value = randomExample;
            chatMessageInput.dispatchEvent(new Event('input'));
        }

        // æ·»åŠ ç¤ºä¾‹æŒ‰é’®
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¾“å…¥æ¡†ä¸‹æ–¹æ·»åŠ ç¤ºä¾‹æŒ‰é’®
            const inputArea = document.querySelector('.chat-input-area');
            const exampleBtn = document.createElement('button');
            exampleBtn.textContent = 'å¡«å……ç¤ºä¾‹æ–‡æœ¬';
            exampleBtn.style.cssText = 'padding:6px 12px; margin-top:10px; background:#6c757d; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer;';
            exampleBtn.onclick = fillExampleText;
            
            const btnContainer = document.querySelector('.send-btn-container');
            btnContainer.parentNode.insertBefore(exampleBtn, btnContainer);
        });
    </script>
</body>
</html>