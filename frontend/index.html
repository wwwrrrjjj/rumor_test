<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è°£è¨€ç”„åˆ«ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", sans-serif; background: #f5f5f5; }
        
        /* ç™»å½•/æ³¨å†ŒåŒºåŸŸæ ·å¼ï¼ˆä¿ç•™åŸæœ‰ï¼‰ */
        .container { width: 90%; max-width: 1000px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .title { text-align: center; margin-bottom: 30px; color: #333; }
        .section { margin-bottom: 20px; }
        /* å¼ºåŒ–éšè—æ ·å¼ï¼Œæå‡ä¼˜å…ˆçº§ */
        .hidden { display: none !important; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .hint { font-size: 12px; color: #999; margin-top: 5px; }
        .switch-btn { text-align: center; margin-top: 10px; color: #007bff; cursor: pointer; font-size: 14px; }
        .switch-btn:hover { text-decoration: underline; }

        /* ========== ChatGPTé£æ ¼å¯¹è¯åŒºåŸŸæ ·å¼ ========== */
        .chat-container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            height: 80vh;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.08);
            overflow: hidden;
            /* åˆå§‹é»˜è®¤éšè—ï¼Œé¿å…æœªç™»å½•æ—¶æ˜¾ç¤º */
            display: none;
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            padding: 16px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }
        .chat-header-btns {
            display: flex;
            gap: 10px;
        }
        .chat-header-btn {
            padding: 8px 16px;
            font-size: 14px;
            background: #6c757d;
        }
        .chat-header-btn:hover {
            background: #5a6268;
        }

        /* èŠå¤©å†…å®¹åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f9fafb;
        }
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        /* æ¶ˆæ¯æ°”æ³¡é€šç”¨æ ·å¼ */
        .message {
            margin-bottom: 20px;
            display: flex;
            max-width: 85%;
        }
        /* ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰ */
        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        /* ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰ */
        .message.system {
            margin-right: auto;
        }

        /* æ¶ˆæ¯å¤´åƒ */
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .message.user .message-avatar {
            background: #28a745;
        }

        /* æ¶ˆæ¯å†…å®¹ */
        .message-content {
            margin: 0 12px;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
        }
        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.system .message-content {
            background: white;
            border: 1px solid #eee;
            border-bottom-left-radius: 4px;
            color: #333;
        }

        /* æ¶ˆæ¯å†…çš„ç»“æœè¯¦æƒ…æ ·å¼ */
        .result-detail {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.05);
            font-size: 14px;
        }
        .result-detail p {
            margin-bottom: 5px;
        }
        .reasoning-step {
            margin-left: 10px;
            margin-top: 3px;
            font-size: 13px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .type-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .type-selector label {
            margin: 0;
            font-size: 14px;
        }
        .type-selector select {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }
        .text-input-container {
            position: relative;
        }
        #chat-message-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            height: 80px;
            font-size: 14px;
            line-height: 1.5;
        }
        .input-hint {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #999;
        }
        .send-btn-container {
            display: flex;
            justify-content: flex-end;
        }
        #send-message-btn {
            padding: 10px 24px;
            background: #007bff;
            font-size: 14px;
        }

        /* å†å²è®°å½•å¼¹çª—æ ·å¼ */
        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .history-modal-content {
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 12px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .history-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-modal-header h3 {
            font-size: 16px;
            color: #333;
        }
        .close-modal-btn {
            background: transparent;
            color: #666;
            font-size: 20px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .history-modal-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            margin-bottom: 8px;
            border-radius: 6px;
            background: #f9fafb;
        }
        .history-item p {
            margin-bottom: 4px;
            font-size: 14px;
        }
        .history-item strong {
            color: #555;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•/æ³¨å†ŒåŒºåŸŸï¼ˆä¿ç•™åŸæœ‰ï¼‰ -->
    <div class="container" id="auth-container">
        <h1 class="title">è°£è¨€ç”„åˆ«ç³»ç»Ÿ</h1>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div id="login-section" class="section">
            <h2>ç”¨æˆ·ç™»å½•</h2>
            <div>
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div style="margin-top: 15px;">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button id="login-btn" style="width:100%; margin-top:10px;">ç™»å½•</button>
            <div class="switch-btn" id="to-register-btn">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿç‚¹å‡»æ³¨å†Œ</div>
        </div>

        <!-- æ³¨å†ŒåŒºåŸŸ -->
        <div id="register-section" class="section hidden">
            <h2>ç”¨æˆ·æ³¨å†Œ</h2>
            <div>
                <label for="reg-username">ç”¨æˆ·å</label>
                <input type="text" id="reg-username" placeholder="è¯·è®¾ç½®ç”¨æˆ·å">
            </div>
            <div style="margin-top: 15px;">
                <label for="reg-password">å¯†ç </label>
                <input type="password" id="reg-password" placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆ6-72ä½ï¼‰">
            </div>
            <div style="margin-top: 15px;">
                <label for="reg-confirm-password">ç¡®è®¤å¯†ç </label>
                <input type="password" id="reg-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
            </div>
            <button id="register-btn" style="width:100%; margin-top:10px;">æ³¨å†Œ</button>
            <div class="switch-btn" id="to-login-btn">å·²æœ‰è´¦å·ï¼Ÿç‚¹å‡»ç™»å½•</div>
        </div>
    </div>

    <!-- ========== ChatGPTé£æ ¼å¯¹è¯åŒºåŸŸ ========== -->
    <div class="chat-container" id="chat-container">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="chat-header">
            <h2>è°£è¨€ç”„åˆ«åŠ©æ‰‹</h2>
            <div class="chat-header-btns">
                <button class="chat-header-btn" id="history-btn">æŸ¥çœ‹å†å²è®°å½•</button>
                <button class="chat-header-btn" id="logout-btn">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
        <div class="chat-messages" id="chat-messages">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message system">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯è°£è¨€ç”„åˆ«åŠ©æ‰‹ï¼Œè¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬ï¼Œæˆ‘ä¼šä¸ºä½ åˆ†ææ˜¯å¦ä¸ºè°£è¨€ä»¥åŠç›¸å…³æ¨ç†è¿‡ç¨‹ã€‚
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-area">
            <div class="input-container">
                <div class="type-selector">
                    <label for="rumor-type">è°£è¨€ç±»å‹ï¼š</label>
                    <select id="rumor-type">
                        <option value="ç–«æƒ…ç›¸å…³">ç–«æƒ…ç›¸å…³</option>
                        <option value="é£Ÿå“å®‰å…¨">é£Ÿå“å®‰å…¨</option>
                        <option value="ç¤¾ä¼šäº‹ä»¶">ç¤¾ä¼šäº‹ä»¶</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="text-input-container">
                    <textarea id="chat-message-input" placeholder="è¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬ï¼ˆ1-500å­—ï¼‰..."></textarea>
                    <div class="input-hint" id="input-length-hint">0/500</div>
                </div>
                <div class="send-btn-container">
                    <button id="send-message-btn">å‘é€æ£€æµ‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å†å²è®°å½•å¼¹çª— -->
    <div class="history-modal" id="history-modal">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h3>æ£€æµ‹å†å²è®°å½•</h3>
                <button class="close-modal-btn" id="close-modal-btn">Ã—</button>
            </div>
            <div class="history-modal-body" id="history-list">
                <!-- å†å²è®°å½•å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Axios -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let token = "";
        let userId = "";

        // DOMå…ƒç´ è·å–
        // ç™»å½•/æ³¨å†Œç›¸å…³
        const authContainer = document.getElementById("auth-container");
        const loginSection = document.getElementById("login-section");
        const registerSection = document.getElementById("register-section");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById("login-btn");
        const toRegisterBtn = document.getElementById("to-register-btn");
        const regUsernameInput = document.getElementById("reg-username");
        const regPasswordInput = document.getElementById("reg-password");
        const regConfirmPasswordInput = document.getElementById("reg-confirm-password");
        const registerBtn = document.getElementById("register-btn");
        const toLoginBtn = document.getElementById("to-login-btn");

        // èŠå¤©åŒºåŸŸç›¸å…³
        const chatContainer = document.getElementById("chat-container");
        const chatMessages = document.getElementById("chat-messages");
        const chatMessageInput = document.getElementById("chat-message-input");
        const inputLengthHint = document.getElementById("input-length-hint");
        const rumorTypeSelect = document.getElementById("rumor-type");
        const sendMessageBtn = document.getElementById("send-message-btn");
        const historyBtn = document.getElementById("history-btn");
        const logoutBtn = document.getElementById("logout-btn");

        // å†å²è®°å½•å¼¹çª—ç›¸å…³
        const historyModal = document.getElementById("history-modal");
        const historyList = document.getElementById("history-list");
        const closeModalBtn = document.getElementById("close-modal-btn");

        // é¡µé¢åŠ è½½å®Œæˆåå¼ºåˆ¶åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
        window.onload = function() {
            // å¼ºåˆ¶éšè—èŠå¤©å®¹å™¨
            chatContainer.style.display = "none";
            // ç¡®ä¿ç™»å½•/æ³¨å†Œå®¹å™¨æ˜¾ç¤º
            authContainer.style.display = "block";
            // ä½¿ç”¨classListç¡®ä¿æ­£ç¡®çš„æ˜¾ç¤ºçŠ¶æ€
            loginSection.classList.remove("hidden");
            registerSection.classList.add("hidden");
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œæç¤º
            chatMessageInput.value = "";
            inputLengthHint.textContent = "0/500";
            // éšè—å†å²è®°å½•å¼¹çª—
            historyModal.style.display = "none";
            // æ¸…ç©ºç™»å½•/æ³¨å†Œè¾“å…¥æ¡†
            usernameInput.value = "";
            passwordInput.value = "";
            regUsernameInput.value = "";
            regPasswordInput.value = "";
            regConfirmPasswordInput.value = "";
            
            console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆ");
            console.log("ç™»å½•åŒºåŸŸéšè—çŠ¶æ€:", loginSection.classList.contains("hidden"));
            console.log("æ³¨å†ŒåŒºåŸŸéšè—çŠ¶æ€:", registerSection.classList.contains("hidden"));
        };

        // ç™»å½•/æ³¨å†Œåˆ‡æ¢é€»è¾‘ - ä¿®å¤ç‰ˆæœ¬
        function switchTab(tabName) {
            console.log("åˆ‡æ¢åˆ°:", tabName);
            if (tabName === "login") {
                loginSection.classList.remove("hidden");
                registerSection.classList.add("hidden");
            } else {
                loginSection.classList.add("hidden");
                registerSection.classList.remove("hidden");
            }
        }

        toRegisterBtn.addEventListener("click", () => {
            console.log("ç‚¹å‡»åˆ‡æ¢åˆ°æ³¨å†Œ");
            switchTab("register");
        });
        
        toLoginBtn.addEventListener("click", () => {
            console.log("ç‚¹å‡»åˆ‡æ¢åˆ°ç™»å½•");
            switchTab("login");
        });

        // å·¥å…·å‡½æ•°ï¼šæç¤ºæ¡†
        function showToast(msg, isError = false) {
            alert(msg);
        }

        // å·¥å…·å‡½æ•°ï¼šæ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessageToChat(content, isUser = false, resultData = null) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${isUser ? "user" : "system"}`;
            
            // å¤´åƒ
            const avatarDiv = document.createElement("div");
            avatarDiv.className = "message-avatar";
            avatarDiv.textContent = isUser ? "ğŸ‘¤" : "ğŸ¤–";
            
            // å†…å®¹
            const contentDiv = document.createElement("div");
            contentDiv.className = "message-content";
            contentDiv.textContent = content;

            // å¦‚æœæ˜¯ç³»ç»Ÿæ¶ˆæ¯ä¸”æœ‰æ£€æµ‹ç»“æœï¼Œæ·»åŠ ç»“æœè¯¦æƒ…
            if (!isUser && resultData) {
                const resultDetailDiv = document.createElement("div");
                resultDetailDiv.className = "result-detail";
                
                let aiGeneratedText = resultData.is_ai_generated ? "æ˜¯" : "å¦";
                let reasoningStepsHtml = "";
                resultData.reasoning_steps.forEach((step, index) => {
                    reasoningStepsHtml += `<div class="reasoning-step">${index + 1}. ${step}</div>`;
                });

                // æ–°å¢å…³é”®å­—å±•ç¤º
                let keywordsHtml = "";
                resultData.keywords.forEach(keyword => {
                    keywordsHtml += `${keyword} `;
                });

                resultDetailDiv.innerHTML = `
                    <p><strong>æ ¸å¿ƒå…³é”®å­—ï¼š</strong>${keywordsHtml}</p>
                    <p><strong>è°£è¨€æ¦‚ç‡ï¼š</strong>${resultData.rumor_prob}</p>
                    <p><strong>æ˜¯å¦AIç”Ÿæˆï¼š</strong>${aiGeneratedText}</p>
                    <p><strong>æ¨ç†è¿‡ç¨‹ï¼š</strong></p>
                    ${reasoningStepsHtml}
                `;
                contentDiv.appendChild(resultDetailDiv);
            }

            // ç»„è£…æ¶ˆæ¯å…ƒç´ 
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ³¨å†Œé€»è¾‘ï¼ˆä¿®å¤åï¼‰
        registerBtn.addEventListener("click", async () => {
            const username = regUsernameInput.value.trim();
            const password = regPasswordInput.value.trim();
            const confirmPassword = regConfirmPasswordInput.value.trim();

            console.log("æ³¨å†Œå°è¯•ï¼Œç”¨æˆ·å:", username, "å¯†ç é•¿åº¦:", password.length);

            if (!username || !password || !confirmPassword) {
                showToast("æ‰€æœ‰å­—æ®µä¸èƒ½ä¸ºç©ºï¼", true);
                return;
            }
            // è¡¥å……å¯†ç é•¿åº¦ä¸Šé™æ ¡éªŒï¼ˆåŒ¹é…åç«¯72ä½ï¼‰
            if (password.length < 6 || password.length > 72) {
                showToast("å¯†ç é•¿åº¦éœ€6-72ä½ï¼", true);
                return;
            }
            if (password !== confirmPassword) {
                showToast("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼", true);
                return;
            }

            try {
                const response = await axios.post(
                    "http://localhost:8000/api/register",
                    { 
                        username: username, 
                        password: password, 
                        confirm_password: confirmPassword 
                    }
                );

                console.log("æ³¨å†Œå“åº”:", response.data);

                if (response.data.code === 200) {
                    showToast("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ï¼");
                    
                    // åˆ‡æ¢åˆ°ç™»å½•ç•Œé¢
                    switchTab("login");
                    
                    // è‡ªåŠ¨å¡«å……ç”¨æˆ·ååˆ°ç™»å½•æ¡†
                    usernameInput.value = username;
                    
                    // æ¸…ç©ºæ³¨å†Œè¾“å…¥æ¡†
                    regUsernameInput.value = "";
                    regPasswordInput.value = "";
                    regConfirmPasswordInput.value = "";
                } else {
                    showToast(response.data.msg || "æ³¨å†Œå¤±è´¥ï¼", true);
                }
            } catch (error) {
                console.error("æ³¨å†Œé”™è¯¯:", error);
                // å®Œå–„é”™è¯¯å¤„ç†
                const errMsg = error.response?.data?.detail || error.message || "æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                showToast(errMsg, true);
            }
        });

        // ç™»å½•é€»è¾‘
        loginBtn.addEventListener("click", async () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showToast("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼", true);
                return;
            }

            try {
                const response = await axios.post(
                    "http://localhost:8000/api/login",
                    { username: username, password: password }
                );

                if (response.data.code === 200) {
                    token = response.data.data.token;
                    userId = response.data.data.user_id;
                    showToast("ç™»å½•æˆåŠŸï¼");
                    
                    // éšè—ç™»å½•/æ³¨å†ŒåŒºåŸŸï¼Œæ˜¾ç¤ºèŠå¤©åŒºåŸŸ
                    authContainer.style.display = "none";
                    chatContainer.style.display = "flex"; // æ¢å¤chat-containerçš„flexå¸ƒå±€
                }
            } catch (error) {
                const errMsg = error.response?.data?.detail || "ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                showToast(errMsg, true);
            }
        });

        // é€€å‡ºç™»å½•é€»è¾‘
        logoutBtn.addEventListener("click", () => {
            // æ¸…ç©ºtokenå’Œç”¨æˆ·ä¿¡æ¯
            token = "";
            userId = "";
            // æ¸…ç©ºèŠå¤©è®°å½•ï¼ˆä¿ç•™æ¬¢è¿è¯­ï¼‰
            chatMessages.innerHTML = `
                <div class="message system">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        ä½ å¥½ï¼æˆ‘æ˜¯è°£è¨€ç”„åˆ«åŠ©æ‰‹ï¼Œè¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬ï¼Œæˆ‘ä¼šä¸ºä½ åˆ†ææ˜¯å¦ä¸ºè°£è¨€ä»¥åŠç›¸å…³æ¨ç†è¿‡ç¨‹ã€‚
                    </div>
                </div>
            `;
            // éšè—èŠå¤©åŒºåŸŸï¼Œæ˜¾ç¤ºç™»å½•åŒºåŸŸ
            chatContainer.style.display = "none";
            authContainer.style.display = "block";
            
            // é‡ç½®ç™»å½•/æ³¨å†Œç•Œé¢çŠ¶æ€
            loginSection.classList.remove("hidden");
            registerSection.classList.add("hidden");
            
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
            chatMessageInput.value = "";
            inputLengthHint.textContent = "0/500";
            usernameInput.value = "";
            passwordInput.value = "";
            regUsernameInput.value = "";
            regPasswordInput.value = "";
            regConfirmPasswordInput.value = "";
            
            // æ˜¾ç¤ºæç¤º
            showToast("å·²é€€å‡ºç™»å½•");
        });

        // è¾“å…¥æ¡†é•¿åº¦å®æ—¶æ£€æµ‹
        chatMessageInput.addEventListener("input", () => {
            const length = chatMessageInput.value.length;
            inputLengthHint.textContent = `${length}/500`;
            inputLengthHint.style.color = length > 500 ? "red" : "#999";
        });

        // å‘é€æ£€æµ‹æ¶ˆæ¯é€»è¾‘
        sendMessageBtn.addEventListener("click", async () => {
            const content = chatMessageInput.value.trim();
            const type = rumorTypeSelect.value;

            // æ ¡éªŒæ–‡æœ¬é•¿åº¦
            if (content.length < 1 || content.length > 500) {
                showToast("æ–‡æœ¬é•¿åº¦å¿…é¡»åœ¨1-500å­—ä¹‹é—´ï¼", true);
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            addMessageToChat(content, true);
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatMessageInput.value = "";
            inputLengthHint.textContent = "0/500";

            // è°ƒç”¨æ£€æµ‹æ¥å£
            try {
                const response = await axios.post(
                    "http://localhost:8000/api/detect",
                    { content: content, type: type },
                    { headers: { "Authorization": `Bearer ${token}` } }
                );

                if (response.data.code === 200) {
                    const data = response.data.data;
                    // æ·»åŠ ç³»ç»Ÿå›å¤æ¶ˆæ¯ï¼ˆåŒ…å«æ£€æµ‹ç»“æœï¼‰
                    addMessageToChat("å·²å®Œæˆæ£€æµ‹ï¼Œç»“æœå¦‚ä¸‹ï¼š", false, data);
                }
            } catch (error) {
                const errMsg = error.response?.data?.detail || "æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                addMessageToChat(`æ£€æµ‹å‡ºé”™ï¼š${errMsg}`, false);
                showToast(errMsg, true);
            }
        });

        // æŸ¥çœ‹å†å²è®°å½•é€»è¾‘ï¼ˆå¼¹çª—å½¢å¼ï¼‰
        historyBtn.addEventListener("click", async () => {
            try {
                const response = await axios.get("http://localhost:8000/api/history", {
                    headers: { "Authorization": `Bearer ${token}` },
                    params: { page: 1, size: 20 }
                });

                if (response.data.code === 200) {
                    const historyData = response.data.data.list;
                    historyList.innerHTML = "";

                    if (historyData.length === 0) {
                        historyList.innerHTML = "<p style='text-align:center; color:#999;'>æš‚æ— æ£€æµ‹è®°å½•</p>";
                    } else {
                        historyData.forEach(item => {
                            const itemDiv = document.createElement("div");
                            itemDiv.className = "history-item";
                            itemDiv.innerHTML = `
                                <p><strong>æ£€æµ‹æ—¶é—´ï¼š</strong>${item.create_time}</p>
                                <p><strong>æ–‡æœ¬ï¼š</strong>${item.content.length > 60 ? item.content.substring(0, 60) + "..." : item.content}</p>
                                <p><strong>ç±»å‹ï¼š</strong>${item.type}</p>
                                <p><strong>è°£è¨€æ¦‚ç‡ï¼š</strong>${item.rumor_prob}</p>
                                <p><strong>æ˜¯å¦AIç”Ÿæˆï¼š</strong>${item.is_ai_generated ? "æ˜¯" : "å¦"}</p>
                            `;
                            historyList.appendChild(itemDiv);
                        });
                    }

                    // æ˜¾ç¤ºå¼¹çª—
                    historyModal.style.display = "flex";
                }
            } catch (error) {
                const errMsg = error.response?.data?.detail || "æŸ¥è¯¢å†å²å¤±è´¥ï¼Œè¯·é‡è¯•ï¼";
                showToast(errMsg, true);
            }
        });

        // å…³é—­å†å²è®°å½•å¼¹çª—
        closeModalBtn.addEventListener("click", () => {
            historyModal.style.display = "none";
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.addEventListener("click", (e) => {
            if (e.target === historyModal) {
                historyModal.style.display = "none";
            }
        });

        // æŒ‰Enteré”®å‘é€æ¶ˆæ¯ï¼ˆæŒ‰ä½Shift+Enteræ¢è¡Œï¼‰
        chatMessageInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessageBtn.click();
            }
        });
    </script>
</body>
</html>